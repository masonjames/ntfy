name: Build and Push to GHCR

on:
  push:
    branches:
      - main
  schedule:
    # Weekly rebuild on Monday at 07:00 UTC (picks up base image security patches)
    - cron: '0 7 * * 1'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: masonjames/ntfy

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    outputs:
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest,enable=${{ github.ref == format('refs/heads/{0}', 'main') }}

      - name: Get version info
        id: version
        run: |
          VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
          COMMIT=$(git rev-parse --short HEAD)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile-build
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
            COMMIT=${{ steps.version.outputs.commit }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Output image info
        run: |
          echo "Image pushed to GHCR"
          echo "Tags: ${{ steps.meta.outputs.tags }}"
          echo "Digest: ${{ steps.build.outputs.digest }}"

  deploy:
    name: Deploy to Dokploy
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    outputs:
      deploy_failed: ${{ steps.webhook.outputs.deploy_failed }}

    steps:
      - name: Redeploy via Dokploy Webhook
        id: webhook
        env:
          WEBHOOK_URL: ${{ secrets.DOKPLOY_WEBHOOK_NTFY }}
        if: env.WEBHOOK_URL != ''
        run: |
          if ! curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            --fail --silent --show-error 2>&1; then
            echo "::warning::Dokploy webhook failed — deployment may not have triggered"
            echo "deploy_failed=true" >> $GITHUB_OUTPUT
          else
            echo "deploy_failed=false" >> $GITHUB_OUTPUT
          fi

  notify-failure:
    name: Notify on Failure
    needs: [build-and-push, deploy]
    if: always() && (failure() || needs.deploy.outputs.deploy_failed == 'true')
    runs-on: ubuntu-latest

    steps:
      - name: Determine failure type
        id: failure_info
        run: |
          if [ "${{ needs.build-and-push.result }}" = "failure" ]; then
            echo "title=ntfy GHCR build failed" >> $GITHUB_OUTPUT
            echo "subject=ntfy Build FAILED" >> $GITHUB_OUTPUT
            echo "detail=Docker image build failed for ntfy (${GITHUB_EVENT_NAME})." >> $GITHUB_OUTPUT
          elif [ "${{ needs.deploy.outputs.deploy_failed }}" = "true" ]; then
            echo "title=ntfy deploy webhook failed" >> $GITHUB_OUTPUT
            echo "subject=ntfy Deploy FAILED" >> $GITHUB_OUTPUT
            echo "detail=Dokploy webhook deploy failed for ntfy. Image was built but deployment did not trigger." >> $GITHUB_OUTPUT
          else
            echo "title=ntfy build/deploy failed" >> $GITHUB_OUTPUT
            echo "subject=ntfy Build/Deploy FAILED" >> $GITHUB_OUTPUT
            echo "detail=Build or deploy failed for ntfy (${GITHUB_EVENT_NAME})." >> $GITHUB_OUTPUT
          fi

      - name: Send ntfy notification
        env:
          NTFY_BASE_URL: ${{ secrets.NTFY_BASE_URL }}
          NTFY_TOKEN: ${{ secrets.NTFY_TOKEN }}
        if: env.NTFY_BASE_URL != '' && env.NTFY_TOKEN != ''
        run: |
          HTTP_CODE=$(curl -sS -o /tmp/ntfy_resp.txt -w '%{http_code}' \
            -X POST "${NTFY_BASE_URL}/platform-alerts" \
            -H "Authorization: Bearer ${NTFY_TOKEN}" \
            -H "Title: ${{ steps.failure_info.outputs.title }}" \
            -H "Priority: high" \
            -H "Tags: rotating_light,ntfy" \
            -H "Click: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}" \
            --data-raw "${{ steps.failure_info.outputs.detail }} Run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}")

          if [[ ! "$HTTP_CODE" =~ ^2[0-9]{2}$ ]]; then
            echo "::warning::ntfy notification failed (HTTP $HTTP_CODE): $(cat /tmp/ntfy_resp.txt)"
          else
            echo "ntfy notification sent (HTTP $HTTP_CODE)"
          fi

      - name: Send email notification via Resend
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
        if: env.RESEND_API_KEY != ''
        run: |
          RUN_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          PAYLOAD=$(cat <<JSONEOF
          {
            "from": "alerts@platform-core.masonjames.com",
            "to": ["me@masonjames.com"],
            "subject": "${{ steps.failure_info.outputs.subject }}",
            "html": "<!doctype html><html><head><meta charset='UTF-8'/></head><body style='margin:0;padding:0;background:#f6f8fb;font-family:Inter,Helvetica,Arial,sans-serif;color:#0f172a;'><table role='presentation' cellpadding='0' cellspacing='0' width='100%' style='background:#f6f8fb;padding:24px 0;'><tr><td align='center'><table role='presentation' cellpadding='0' cellspacing='0' width='600' style='background:#ffffff;border-radius:16px;box-shadow:0 10px 40px rgba(15,23,42,0.08);overflow:hidden;'><tr><td style='padding:24px 32px 12px 32px;'><div style='font-size:18px;font-weight:700;color:#111827;'>Mason James Hosting</div><div style='font-size:14px;color:#64748b;margin-top:4px;'>CI/CD Alert</div></td></tr><tr><td style='background:#fef2f2;padding:16px 32px;'><div style='font-size:15px;font-weight:600;color:#991b1b;'>${{ steps.failure_info.outputs.subject }}</div></td></tr><tr><td style='padding:16px 32px 12px 32px;'><div style='font-size:15px;line-height:1.6;color:#0f172a;'>${{ steps.failure_info.outputs.detail }}</div></td></tr><tr><td align='center' style='padding:16px 32px;'><a href='${RUN_URL}' style='background:#2563eb;color:#fff;padding:12px 20px;border-radius:8px;font-weight:600;text-decoration:none;font-family:Inter,Helvetica,Arial,sans-serif;'>View GitHub Actions Run</a></td></tr><tr><td style='padding:16px 32px;'><div style='height:1px;background:#e2e8f0;'></div></td></tr><tr><td style='padding:0 32px 24px 32px;font-size:12px;line-height:1.5;color:#94a3b8;'>Repository: ${GITHUB_REPOSITORY} · Event: ${GITHUB_EVENT_NAME} · Ref: ${GITHUB_REF}</td></tr></table></td></tr></table></body></html>"
          }
          JSONEOF
          )

          HTTP_CODE=$(curl -sS -o /tmp/resend_resp.txt -w '%{http_code}' \
            -X POST https://api.resend.com/emails \
            -H "Authorization: Bearer ${RESEND_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          if [[ ! "$HTTP_CODE" =~ ^2[0-9]{2}$ ]]; then
            echo "::warning::Resend email failed (HTTP $HTTP_CODE): $(cat /tmp/resend_resp.txt)"
          else
            echo "Email notification sent (HTTP $HTTP_CODE)"
          fi
